name: 'HCP Terraform Run'
description: 'Trigger an HCP Terraform run using official HashiCorp GitHub Actions'

inputs:
  tfc_hostname:
    description: 'HCP Terraform hostname (default: https://app.terraform.io)'
    required: false
    default: 'https://app.terraform.io'
  tfc_organization:
    description: 'HCP Terraform organization name'
    required: true
  tfc_workspace:
    description: 'HCP Terraform workspace name'
    required: true
  terraform_directory:
    description: 'Path to Terraform configuration'
    required: false
    default: '.'
  tfc_token:
    description: 'HCP Terraform API token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Ensure HCP Terraform Workspace Exists and Create if Not
      shell: bash
      env:
        TFC_ORG: ${{ inputs.tfc_organization }}
        TFC_WORKSPACE: ${{ inputs.tfc_workspace }}
        TFC_TOKEN: ${{ inputs.tfc_token }}
      run: |
        echo "Checking if workspace '$TFC_WORKSPACE' exists in org '$TFC_ORG'..."

        response=$(curl -s -o response.json -w "%{http_code}" \
          --header "Authorization: Bearer $TFC_TOKEN" \
          --header "Content-Type: application/vnd.api+json" \
          "https://app.terraform.io/api/v2/organizations/$TFC_ORG/workspaces/$TFC_WORKSPACE")

        if [ "$response" = "404" ]; then
          echo "Workspace not found. Creating workspace '$TFC_WORKSPACE'..."
          curl -s \
            --header "Authorization: Bearer $TFC_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data '{
              "data": {
                "type": "workspaces",
                "attributes": {
                  "name": "'"$TFC_WORKSPACE"'"
                }
              }
            }' \
            "https://app.terraform.io/api/v2/organizations/$TFC_ORG/workspaces"
          echo "Workspace created."
        elif [ "$response" = "200" ]; then
          echo "Workspace already exists."
        else
          echo "Unexpected response: HTTP $response"
          cat response.json
          exit 1
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload Terraform Configuration
      uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
      with:
        tfc_hostname: ${{ inputs.tfc_hostname }}
        organization: ${{ inputs.tfc_organization }}
        workspace: ${{ inputs.tfc_workspace }}
        path: ${{ inputs.terraform_directory }}
        token: ${{ inputs.tfc_token }}

    - name: Create Terraform Run
      id: create-run
      uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
      with:
        hostname: ${{ inputs.tfc_hostname }}
        organization: ${{ inputs.tfc_organization }}
        workspace: ${{ inputs.tfc_workspace }}
        message: 'Triggered via GitHub Actions'
        token: ${{ inputs.tfc_token }}

    - name: Wait for Plan & Display
      uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.3.2
      with:
        hostname: ${{ inputs.tfc_hostname }}
        plan: ${{ steps.create-run.outputs.plan_id }}
        token: ${{ inputs.tfc_token }}

    - name: Auto Apply (if not speculative or destroy)
      # Ensure run is not from PR or pre-merge context and not a destroy operation.
      if: steps.create-run.outputs.is_speculative == 'false' && steps.create-run.outputs.is_destroy == 'false'
      uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
      with:
        hostname: ${{ inputs.tfc_hostname }}
        run: ${{ steps.create-run.outputs.run_id }}
        token: ${{ inputs.tfc_token }}
